build docs:
  stage: build
  needs: [meta]
  tags: [shell, envinf]
  timeout: 30 minutes
  variables:
    DOX_WARNINGS_THRESHOLD: 10
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        PAGES_PREFIX: doxygen
    - if: '$CI_COMMIT_BRANCH == "master"'
      variables:
        PAGES_PREFIX: doxygen
    - if: $CI_MERGE_REQUEST_IID
      variables:
        PAGES_PREFIX: doxygen-mr-$CI_MERGE_REQUEST_IID
  script:
    - rm -rf build
    - mkdir -p build
    # cpp-dependencies
    - NUM_CYCLES=`cpp-dependencies --stats|grep cycles|cut -d " " -f 2`
    - echo "num_cycles $NUM_CYCLES" > metrics.txt
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - docker run --rm -v $PWD:/work registry.opengeosys.org/ogs/ogs/cpp-dependencies cpp-dependencies --graph build/cpp-dependencies.dot
    - dot -Tsvg build/cpp-dependencies.dot -o build/cpp-dependencies.svg
    # lizard, default code complexity number (15), function line length 100, max arguments 10
    - uvx --with jinja2 lizard==1.19.0 -l cpp -w -t 1 --length 100 --arguments 10 > lizard.txt || true
    - cat lizard.txt
    - NUM_LIZARD_ISSUES=`cat lizard.txt | wc -l`
    - echo "lizard_issues $NUM_LIZARD_ISSUES" >> metrics.txt
    # Disabled as the commands often time-out on envinfs but usually can be run locally just fine:
    # - uvx --with jinja2 lizard==1.19.0 -l cpp -t 8 --html -o Lizard.html
    # - uvx --with jinja2 lizard==1.19.0 -EWordCount -x "./Tests/*" || true # word-cloud
    # build
    - cd build
    - DOXYGEN_PATH=`guix shell doxygen -- which doxygen`
    - cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DOGS_BUILD_PROCESSES=SteadyStateDiffusion -DDOXYGEN_EXECUTABLE=$DOXYGEN_PATH
    - cmake . --graphviz=cmake-dependencies.dot && dot -Tsvg cmake-dependencies.dot -o cmake-dependencies.svg
    - cmake .
    - cmake --build . --target doc 2>&1 | tee make-docs.output
    - npx -y pagefind --site docs # pagefind index
    - cat make-docs.output DoxygenWarnings.log | grep 'warning:' | grep -v 'too many nodes\|perl:' > DoxygenWarnings-filtered.log
    - NUM_DOX_WARNINGS="`cat DoxygenWarnings-filtered.log | wc -l`"
    - echo "doxygen_warnings $NUM_DOX_WARNINGS" >> metrics.txt
    - |
      if [ "$NUM_DOX_WARNINGS" -gt "$DOX_WARNINGS_THRESHOLD" ]; then
        echo "Error: Number of Doxygen warnings exceeded threshold â€“> $NUM_DOX_WARNINGS > $DOX_WARNINGS_THRESHOLD"
        echo "----------------------------------------------------"
        cat DoxygenWarnings-filtered.log
        exit 1
      fi
    - echo "Number of Doxygen warnings is $NUM_DOX_WARNINGS (threshold is $DOX_WARNINGS_THRESHOLD)."
    - |
      if grep '^error: documentation quality check failed' make-docs.output; then
        echo "Error: Doxygen quality assurance check failed"
        exit 1
      fi
  artifacts:
    paths:
      - build/cpp-dependencies.svg
      - build/cmake-dependencies.svg
      # - Lizard.html
      - lizard.txt
      - codecloud.html
      - build/DoxygenWarnings.log
      - build/DoxygenWarnings-filtered.log
    expire_in: 1 week
    reports:
      metrics: build/metrics.txt
    when: always
  pages:
    publish: build/docs
    path_prefix: '$PAGES_PREFIX'
  environment:
    name: doxygen preview $PAGES_PREFIX
    url: $CI_PAGES_URL

deploy docs:
  stage: package
  rules:
    - if: $CI_COMMIT_TAG
  needs: ["build docs"]
  tags: [envinf, shell]
  variables:
    GIT_STRATEGY: none # no checkout
  before_script:
    - npm install -g netlify-cli
  script:
    - rm -rf ogs-doxygen-web
    - git config --global user.name "GitLab CI"
    - git config --global user.email "gitlab-ci-no-reply@opengeosys.org"
    - git clone https://${CI_SERVER_HOST}/ogs/ogs-doxygen-web.git
    - cd ogs-doxygen-web
    - mv ../build/docs $CI_COMMIT_TAG
    - git add $CI_COMMIT_TAG
    - rm stable && ln -s $CI_COMMIT_TAG stable && git add stable
    - git commit -m "Release $CI_COMMIT_TAG"
    - git push "https://${DOXYGEN_CI_COMMITER_USER_AND_TOKEN}@${CI_SERVER_HOST}/ogs/ogs-doxygen-web.git" HEAD:main
  artifacts:
    paths:
      - build/searchdata.xml

deploy doxysearch:
  stage: package
  needs: [ "build docs" ]
  tags: [ doxysearch ]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
  variables:
    GIT_STRATEGY: none # no checkout
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        cp build/searchdata.xml /var/www/doxysearch.opengeosys.org/$CI_COMMIT_BRANCH/
        doxyindexer -o /var/www/doxysearch.opengeosys.org/$CI_COMMIT_BRANCH /var/www/doxysearch.opengeosys.org/$CI_COMMIT_BRANCH/searchdata.xml
      else
        cp build/searchdata.xml /var/www/doxysearch.opengeosys.org/$CI_COMMIT_TAG/
        doxyindexer -o /var/www/doxysearch.opengeosys.org/$CI_COMMIT_TAG /var/www/doxysearch.opengeosys.org/$CI_COMMIT_TAG/searchdata.xml
      fi

check docs links:
  stage: check
  tags: [envinf, shell]
  allow_failure: true
  image:
    name: lycheeverse/lychee
    entrypoint: [""]
  needs: ["build docs"]
  extends:
    - .rules-master-manual
  script:
    - lychee --cache --max-cache-age 2d
      --threads ${CTEST_PARALLEL_LEVEL:-4}
      --exclude gitlab.opengeosys.org/ogs/ogs
      --exclude github.com/ufz/ogs/commit/\%1
      --exclude search_opensearch.php
      --exclude eigen.tuxfamily.org
      --exclude wiki.sei.cmu.edu
      --exclude www.opengeosys.org/project/license
      --exclude stackoverflow.com
      --exclude-path build/docs/d0/de3/citelist.html
      --exclude-path build/docs/doxygen_crawl.html
      --exclude gitlab.io
      build/docs
    # - lychee --cache --max-cache-age 14d
    #   --max-concurrency 2
    #   --include gitlab.opengeosys.org/ogs/ogs
    #   build/docs
  cache:
    paths:
      - .lycheecache

spell check docs:
  image: registry.gitlab.com/gitlab-org/gitlab-docs/lint-markdown:alpine-3.18-vale-2.27.0-markdownlint-0.35.0-markdownlint2-0.8.1
  stage: check
  needs: []
  script:
    - vale web/content --output ./Documentation/.vale/vale-json.tmpl > vale-report.json
  artifacts:
    paths:
      - vale-report.json
    reports:
      codequality: vale-report.json
