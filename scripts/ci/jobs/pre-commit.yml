pre commit:
  stage: preparation
  tags: [envinf, shell]
  rules:
    - if: $CI_MERGE_REQUEST_IID
  variables:
    SKIP: git-clang-format,git-diff-check
  script:
    - uvx pre-commit==4.5.0 install
    - uvx pre-commit==4.5.0 run --from-ref ${CI_MERGE_REQUEST_DIFF_BASE_SHA} --to-ref HEAD

clang-format:
  stage: check
  image: silkeh/clang:18
  needs: []
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /.*ci::web only \(fast.*/
      when: never
    - if: $CI_MERGE_REQUEST_IID
  before_script:
    - apt update
    - apt install -y git
  script:
    - git clang-format --extensions "h,cpp" ${CI_MERGE_REQUEST_DIFF_BASE_SHA}
    - if [[ $(git diff) ]]; then exit 1; fi
  after_script:
    - git diff
