deploy web site:
  stage: package
  image: $WEB_IMAGE
  needs:
    - job: meta
    - job: "build linux arch"
    - job: "build linux petsc"
    - job: release
      optional: true
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        HUGO_PARAMS_CURRENTVERSION: $CI_COMMIT_TAG
        HUGO_BASEURL: https://www.opengeosys.org/$CI_COMMIT_TAG
    - if: '$CI_COMMIT_BRANCH == "master"'
      variables:
        HUGO_BASEURL: $CI_PAGES_URL
  script:
    # FeatureMatrix
    - curl -fSL -O https://gitlab.opengeosys.org/ogs/inf/featurematrix/-/archive/main/featurematrix-main.tar.gz
    - tar xf featurematrix-main.tar.gz
    - cd featurematrix-main
    - uv run featurematrix/FindFeatures.py .. --json ../web/content/docs/featurematrix/bundle/features.json
    - cp -r styles.css utils.js main.js ../web/content/docs/featurematrix/bundle/
    - cd ..
    - |
      find Tests/Data -type f \( -name "*.prj" -o -name "*.md" \) | while IFS= read -r file; do
        target_dir="web/static/docs/featurematrix/bundle/$(dirname "$file")"
        mkdir -p "$target_dir"
        ln -sf "$(realpath "$file")" "$target_dir/$(basename "$file")"
      done
    # FeatureMatrix end
    - cd web
    - python scripts/convert_notebooks.py
    # Copy notebook pages
    - cp -rl ../build/*/web/content ./
    - yarn
    - yarn build
  pages:
    publish: web/public
  cache:
    paths:
      - web/node_modules

deploy web site tag:
  stage: package
  rules:
    - if: $CI_COMMIT_TAG
  needs: [deploy web site]
  tags: [envinf, shell]
  variables:
    GIT_STRATEGY: none
  script:
    - rm -rf ogs-web
    - git config --global user.name "GitLab CI"
    - git config --global user.email "gitlab-ci-no-reply@opengeosys.org"
    - git clone https://${CI_SERVER_HOST}/ogs/ogs-web.git
    - cd ogs-web
    - mv ../web/public $CI_COMMIT_TAG
    - git add $CI_COMMIT_TAG
    - rm stable && ln -s $CI_COMMIT_TAG stable && git add stable
    - git commit -m "Release $CI_COMMIT_TAG"
    - git push "https://${CI_COMMITTER_USER_AND_TOKEN}@${CI_SERVER_HOST}/ogs/ogs-web.git" HEAD:main
