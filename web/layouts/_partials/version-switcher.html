<div x-data="versionSwitcher('{{ site.Params.currentVersion }}', 'https://www.opengeosys.org/_static/versions.json')"
  x-init="loadVersions()" class="relative inline-block text-left">
  <!-- Button -->
  <button @click="open = !open" type="button"
    class="inline-flex items-center gap-1 rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
    <span x-text="'Version: ' + currentVersion"></span>
    <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 20 20" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l3-3 3 3m0 6l-3 3-3-3" />
    </svg>
  </button>

  <!-- Dropdown -->
  <div x-show="open" @click.away="open = false"
    class="absolute right-0 z-10 mt-1 w-32 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5">
    <ul class="py-1 text-sm text-gray-700">
      <template x-for="v in versions" :key="v.version">
        <li>
          <a :href="buildTargetURL(v.version)" class="block px-3 py-1.5 hover:bg-gray-100"
            :class="v.version === currentVersion ? 'font-semibold text-blue-600' : ''" x-text="v.version"></a>
        </li>
      </template>
    </ul>
  </div>
</div>

<script>
  function versionSwitcher(currentVersion, versionsUrl) {
    return {
      open: false,
      currentVersion,
      versions: [],
      async loadVersions() {
        try {
          const response = await fetch(versionsUrl);
          if (!response.ok) throw new Error('Failed to fetch versions.json');
          let data = await response.json();

          // Sort descending (master → newest → older)
          data.sort((a, b) => semverCompareDesc(a.version, b.version));

          this.versions = data;
        } catch (e) {
          console.error(e);
        }
      },

      buildTargetURL(targetVersion) {
        const currentFull = window.location.href;
        const currentPath = window.location.pathname + window.location.search + window.location.hash;

        const targetEntry = this.versions.find(v => v.version === targetVersion);
        if (!targetEntry) return currentFull;

        const toBase = normalizeURL(targetEntry.url);

        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
          // Use current path directly under target base
          const relative = currentPath.replace(/^\/+/, "");
          return toBase + relative;
        }

        const currentEntry = this.versions.find(v => currentFull.startsWith(normalizeURL(v.url)));

        if (currentEntry) {
          const fromBase = normalizeURL(currentEntry.url);
          const relative = currentFull.slice(fromBase.length);
          return toBase + relative;
        }

        // Cannot detect, fallback to version root
        return toBase;
      }
    };
  }

  function normalizeURL(url) {
    return url.endsWith("/") ? url : url + "/";
  }

  function semverCompareDesc(a, b) {
    const special = ["dev", "latest", "main", "master"];
    const aIsSpecial = special.includes(a);
    const bIsSpecial = special.includes(b);

    if (aIsSpecial && !bIsSpecial) return -1;
    if (!aIsSpecial && bIsSpecial) return 1;
    if (aIsSpecial && bIsSpecial) return a.localeCompare(b);

    const pa = a.split('.').map(Number);
    const pb = b.split('.').map(Number);

    for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
      const diff = (pb[i] || 0) - (pa[i] || 0);
      if (diff !== 0) return diff;
    }
    return 0;
  }
</script>